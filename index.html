<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean-German V13 (Stable)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        :root {
            --bg-gradient: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            --text-color: #4A4A4A;
            --accent-color: #845ec2;
            --font-main: "Jua", sans-serif;
            --card-radius: 30px;
        }

        body {
            margin: 0; padding: 0; height: 100vh;
            background: var(--bg-gradient);
            color: var(--text-color);
            font-family: var(--font-main);
            display: flex; justify-content: center; align-items: center;
            user-select: none;
        }

        #app { width: 100%; max-width: 500px; padding: 20px; text-align: center; position: relative; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeUp 0.5s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 2.5rem; color: #fff; text-shadow: 2px 2px 0 rgba(0,0,0,0.1); margin: 0; }
        h2 { color: #fff; font-size: 1.2rem; margin-bottom: 20px; opacity: 0.9; }

        /* Menu */
        .menu-container { height: 65vh; overflow-y: auto; padding: 10px; }
        .menu-btn {
            width: 100%; padding: 20px; margin: 10px 0;
            background: white; border: 4px solid white; border-radius: 25px;
            color: var(--text-color); font-family: var(--font-main); font-size: 1.3rem;
            cursor: pointer; display: flex; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .menu-btn:hover { transform: translateY(-3px); border-color: var(--accent-color); }
        .icon-circle {
            background: var(--accent-color); width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px; color: white; font-size: 1rem; font-weight: bold;
        }

        /* Flashcard */
        .scene {
            width: 100%; height: 480px;
            perspective: 1000px; cursor: pointer;
        }
        .card {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.6s; transform-style: preserve-3d;
            border-radius: var(--card-radius);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        .card.is-flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-radius: var(--card-radius);
            background: white; border: 5px solid white;
            padding: 20px; box-sizing: border-box;
        }
        .card-face.card-back { background: #f9f9f9; transform: rotateY(180deg); border-color: #eee; }

        /* Badges */
        .mode-badge {
            position: absolute; top: 5px; 
            padding: 5px 15px; border-radius: 15px;
            color: white; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .bg-read { background: #4facfe; }
        .bg-listen { background: #f093fb; }
        .bg-speak { background: #fa709a; }

        /* Text Styles */
        .big-text { font-size: 1.8rem; margin: 15px 0; color: #333; line-height: 1.3; transition: 0.3s; word-break: keep-all; }
        .big-text.korean { color: var(--accent-color); }
        .big-text.german { color: #4A4A4A; }
        .big-text.blurred { filter: blur(12px); opacity: 0.6; }
        
        .sub-text { font-size: 1rem; color: #888; margin-top: 5px; }

        /* Audio Btn */
        .play-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: #f0f0f0; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            margin-top: 10px; transition: 0.2s;
        }
        .play-btn:active { transform: scale(0.9); }
        .play-btn svg { width: 28px; height: 28px; fill: #555; }
        .play-btn.highlight { background: var(--accent-color); }
        .play-btn.highlight svg { fill: white; }

        /* Mic Button */
        .mic-container { display: none; flex-direction: column; align-items: center; margin-top: 20px; }
        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%; border: none;
            background: #fa709a; color: white; font-size: 2rem;
            cursor: pointer; box-shadow: 0 10px 20px rgba(250, 112, 154, 0.4);
            transition: all 0.3s; display: flex; justify-content: center; align-items: center;
        }
        .mic-btn.listening { background: #ff4b1f; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 31, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 75, 31, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 31, 0); } }

        .speech-feedback { margin-top: 15px; font-size: 1rem; color: #555; font-style: italic; min-height: 1.5em; }
        .match-success { color: #28a745; font-weight: bold; }
        .match-fail { color: #dc3545; }

        .controls { display: flex; gap: 10px; width: 100%; margin-top: 25px; }
        .ctrl-btn { flex: 1; padding: 15px; border-radius: 20px; border: none; font-family: var(--font-main); font-size: 1.2rem; cursor: pointer; }
        .btn-no { background: #fad0c4; color: #822727; }
        .btn-yes { background: #a8edea; color: #2c7a7b; }

        .stats-bar { display: flex; justify-content: space-between; color: white; font-size: 1.2rem; margin-bottom: 10px; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        
        #error-box { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #8b0000; color: white; padding: 15px; text-align: left; z-index: 9999; font-size: 12px; }
    </style>
</head>
<body>

<div id="error-box"></div>

<div id="app">
    <div id="menu-screen" class="screen active">
        <h1>Korean Master</h1>
        <h2>Voice Edition üé§</h2>
        
        <div class="menu-container">
            <button class="menu-btn" onclick="startGame(1)"><div class="icon-circle">1</div> Level 1: Basics</button>
            <button class="menu-btn" onclick="startGame(2)"><div class="icon-circle">2</div> Level 2: Adjectives</button>
            <button class="menu-btn" onclick="startGame(3)"><div class="icon-circle">3</div> Level 3: Tenses</button>
            <button class="menu-btn" onclick="startGame(4)"><div class="icon-circle">4</div> Level 4: Formality</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="stats-bar">
            <span>Score: <span id="score-val">0</span></span>
            <span>Card: <span id="rem-val">0</span></span>
        </div>

        <div class="scene" id="card-scene">
            <div class="card" id="flashcard">
                
                <div class="card-face card-front">
                    <div id="badge-display" class="mode-badge bg-read">Mode</div>
                    
                    <div class="big-text" id="front-text">...</div>
                    <div class="sub-text" id="front-sub"></div>
                    
                    <button class="play-btn" id="front-audio-btn" onclick="event.stopPropagation(); playAudio()">
                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>

                    <div id="mic-area" class="mic-container">
                        <button class="mic-btn" id="mic-btn" onclick="event.stopPropagation(); activateMic()">üéôÔ∏è</button>
                        <div class="speech-feedback" id="speech-feedback">Tap mic & speak Korean</div>
                    </div>
                    
                    <div style="margin-top:auto; font-size:0.8rem; color:#aaa; margin-bottom: 5px;">(Tap card to Flip)</div>
                </div>

                <div class="card-face card-back">
                    <div style="font-size:0.8rem; text-transform:uppercase; color:#aaa;">Answer</div>
                    <div class="big-text korean" id="back-korean">...</div>
                    <div class="big-text german" id="back-german" style="font-size:1.4rem;">...</div>
                    <button class="play-btn highlight" id="back-audio-btn" onclick="event.stopPropagation(); playAudio()">
                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="ctrl-btn btn-no" onclick="handleResult(false)">Again</button>
            <button class="ctrl-btn btn-yes" onclick="handleResult(true)">Good</button>
        </div>
        
        <button onclick="location.reload()" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Exit / Restart</button>
    </div>

    <div id="finish-screen" class="screen">
        <h1>Fertig! üéâ</h1>
        <p style="color:white; font-size:1.5rem;">Great Job!</p>
        <button class="menu-btn" onclick="location.reload()" style="justify-content:center;">Menu</button>
    </div>
</div>

<script>
    // --- 1. ERROR REPORTING ---
    window.onerror = function(msg, url, line) {
        const box = document.getElementById('error-box');
        box.style.display = 'block';
        box.innerText = "‚ö†Ô∏è Error: " + msg + " (Line " + line + ")";
        return false;
    };

    // --- 2. DATASETS ---
    const dataL1=[{ko:"Ï†Ä ÏÇ¨Í≥ºÎäî ÎÇ®ÏûêÎ•º Î®πÏñ¥Ïöî",de:"Jener Apfel isst den Mann"},{ko:"Ï†Ä ÎÇ®ÏûêÎäî Ïù¥ ÏßëÏùÑ Î®πÏñ¥Ïöî",de:"Jener Mann isst dieses Haus"},{ko:"Ïù¥ ÏßëÏùÄ Ï†Ä Ïó¨ÏûêÎ•º Î®πÏñ¥Ïöî",de:"Dieses Haus isst jene Frau"},{ko:"ÏÑ†ÏÉùÎãòÏùÄ ÌïôÍµêÏóê ÏûàÎã§",de:"Der Lehrer ist in der Schule"},{ko:"ÏÑ†ÏÉùÎãòÏùÄ ÌïôÍµêÍ∞Ä ÏûàÎã§",de:"Der Lehrer hat eine Schule"},{ko:"ÏÑúÏö∏ÏùÄ ÌïúÍµ≠Ïóê ÏûàÎã§",de:"Seoul ist in Korea"},{ko:"ÌïúÍµ≠ÏùÄ ÏÑúÏö∏Ïù¥ ÏûàÎã§",de:"Korea hat Seoul"},{ko:"Ï†Ä ÎÇ®ÏûêÎäî ÏÑ†ÏÉùÎãòÏù¥Îã§",de:"Jener Mann ist Lehrer"}];
    const dataL2=[{ko:"Ï†ÄÎäî ÏùåÏãùÏùÑ ÏõêÌï¥Ïöî",de:"Ich will Essen"},{ko:"Ï†Ä ÏùåÏãùÏùÄ ÌÅ¨Îã§",de:"Das Essen da dr√ºben ist gro√ü"},{ko:"Ï†ÄÎäî ÌÅ∞ ÏùåÏãùÏùÑ ÏõêÌï¥Ïöî",de:"Ich will gro√ües Essen"},{ko:"ÎÇ®ÏûêÎäî ÌÅ∞ Î∞∞Î•º ÎßåÎì§Ïñ¥Ïöî",de:"Der Mann baut ein gro√ües Boot"},{ko:"Ïó¨ÏûêÎäî ÎπÑÏãº ÏºÄÏù¥ÌÅ¨Î•º Î®πÏñ¥Ïöî",de:"Die Frau isst einen teuren Kuchen"},{ko:"Ï†Ä Î∞©ÏïàÏóê Ïãº ÎÉâÏû•Í≥†Í∞Ä ÏûàÏñ¥Ïöî",de:"In jenem Zimmer ist ein billiger K√ºhlschrank"},{ko:"ÏûëÏùÄ Í≥†ÏñëÏù¥Îäî ÎπÑÏãº ÌïôÍµê ÏòÜÏóê ÏûàÏñ¥Ïöî",de:"Die kleine Katze ist neben der teuren Schule"},{ko:"Ï†ÄÎäî Ï¢ãÏùÄ ÌéúÏù¥ ÏûàÏñ¥Ïöî",de:"Ich habe einen guten Stift"},{ko:"Ï†Ä ÎÇ®ÏûêÎäî ÎßéÏùÄ ÎèàÏùÑ ÏõêÌï¥Ïöî",de:"Jener Mann will viel Geld"},{ko:"Ïö∞Î¶¨ ÏÑ†ÏÉùÎãòÏùÄ Ïû¨ÎØ∏ÏûàÎäî ÏÇ¨ÎûåÏù¥ÏóêÏöî",de:"Unser Lehrer ist ein witziger Mensch"},{ko:"Ï†Ä Í≥†ÏñëÏù¥Îäî ÎßõÏûàÎäî ÏùåÏãùÏùÑ Î®πÏñ¥Ïöî",de:"Jene Katze isst leckeres Essen"}];
    const dataL3=[{ko:"ÎÇòÎäî Ïñ¥Ï†ú Î∞•ÏùÑ Î®πÏóàÎã§",de:"Ich habe gestern Reis gegessen"},{ko:"ÎÇòÎäî ÏßÄÍ∏à ÏºÄÏù¥ÌÅ¨Î•º Î®πÎäîÎã§",de:"Ich esse jetzt Kuchen"},{ko:"ÏÇ¨Í≥ºÎäî 3ÏãúÏóê ÎÇòÎ•º Î®πÍ≤†Îã§",de:"Der Apfel wird mich um 3 Uhr essen"},{ko:"ÏπúÍµ¨Îäî Ïñ¥Ï†ú ÏòÅÏñ¥ÎèÑ Î∞∞Ïõ†Îã§",de:"Der Freund hat gestern auch Englisch gelernt"},{ko:"ÎÇòÎäî Í∏àÏöîÏùºÏóê ÌïôÍµê ÏòÜÏóê Î¨∏ÏùÑ Îã´ÎäîÎã§",de:"Ich schlie√üe am Freitag die T√ºr neben der Schule"},{ko:"ÎÇòÎäî Ïò§Îäò ÎπÑÏãº ÏïàÍ≤ΩÏùÑ ÎçòÏßÄÍ≤†Îã§",de:"Ich werde heute die teure Brille werfen"},{ko:"ÎÇòÎäî Ïó¨ÏÑØÏãúÏóê ÎèÖÏùºÏñ¥Î•º Î∞∞Ïö¥Îã§",de:"Ich lerne um 6 Uhr Deutsch"},{ko:"Ï†Ä ÏπúÍµ¨Í∞Ä ÏÇ¨ÏßÑÏùÑ ÎçòÏßÑÎã§",de:"Jener Freund wirft das Foto"},{ko:"ÏÇºÏ¥åÏùÄ 2ÏãúÏóê Î∞ïÎ¨ºÍ¥ÄÏóê Í∞îÎã§",de:"Der Onkel ging um 2 Uhr ins Museum"},{ko:"ÎÇòÎäî ÎÇ¥Ïùº ÌïúÍµ≠Ïñ¥Î•º Î∞∞Ïö∞Í≤†Îã§",de:"Ich werde morgen Koreanisch lernen"},{ko:"ÎÇòÎäî Í±∞Í∏∞ Í∞ÄÍ≤†Îã§",de:"Ich werde dorthin gehen"},{ko:"Ïò§Îπ†Îäî Ïö∞Î¶¨Ïùò ÏûëÏùÄ ÎπÑÎ∞ÄÏùÑ Ïù¥Ìï¥ÌñàÎã§",de:"Der Bruder hat unser kleines Geheimnis verstanden"},{ko:"Ïù¥ Ïó¥Ï∞®Îäî 3ÏãúÏóê ÏÑúÏö∏Ïóê Í∞ÑÎã§",de:"Dieser Zug f√§hrt um 3 Uhr nach Seoul"},{ko:"Ïñ¥Î®∏ÎãàÎäî Í∑∏ Í∏¥ Ìé∏ÏßÄÎ•º Ïù¥Ìï¥ÌïòÍ≤†Îã§",de:"Die Mutter wird den langen Brief verstehen"},{ko:"ÎÇòÎäî Ïñ¥Ï†ú ÏòàÏÅú Í±∞Î¶¨Ïóê ÏôîÎã§",de:"Ich kam gestern zur h√ºbschen Stra√üe"},{ko:"Ïö∞Î¶¨ Ìï†ÏïÑÎ≤ÑÏßÄÎäî ÎÇòÎ•º Ïù¥Ìï¥ÌïúÎã§",de:"Mein Gro√üvater versteht mich"},{ko:"ÎÇòÎäî ÏßÄÍ∏à ÌïúÍµ≠Ïóê Ïò®Îã§",de:"Ich komme jetzt nach Korea"},{ko:"ÏïÑÎ≤ÑÏßÄÎäî ÏõîÏöîÏùºÏóê Í∞ÄÍ≤åÎ•º Îã´ÏïòÎã§",de:"Der Vater hat am Montag den Laden geschlossen"},{ko:"ÌÉùÏãúÎäî ÎÇ¥Ïùº Ïò§Í≤†Îã§",de:"Das Taxi wird morgen kommen"},{ko:"ÎèôÏÉùÏùÄ ÌÜ†ÏöîÏùºÏóê ÎèÖÏùºÏóê Í∞îÎã§",de:"Das Geschwister ging am Samstag nach Deutschland"},{ko:"ÌñâÎ≥µÌïú Ïò§Î¶¨Îäî 8ÏãúÏóê Í≥µÏùÑ ÎçòÏ°åÎã§",de:"Die gl√ºckliche Ente warf um 8 Uhr den Ball"},{ko:"Ìï†Î®∏ÎãàÏùò ÌåîÏùÄ Í∏∏Îã§",de:"Der Arm der Gro√ümutter ist lang"},{ko:"Ïò§Îπ†Ïùò ÌåîÎèÑ Í∏∏Îã§",de:"Der Arm des Bruders ist auch lang"},{ko:"Í∑∏ Í∞ÄÍ≤åÎäî ÏïÑÎ¶ÑÎãµÎã§",de:"Der Laden ist wundersch√∂n"},{ko:"Ïò§Î¶¨Ïùò Íº¨Î¶¨Îäî ÌîºÍ≥§ÌñàÎã§",de:"Der Schwanz der Ente war m√ºde"},{ko:"Ïò§Îäò ÏïÑÏπ®ÏùÄ ÎßõÏûàÏóàÎã§",de:"Das Fr√ºhst√ºck heute war lecker"},{ko:"Ïò§Îπ†Ïùò Í∞ÄÍ≤åÎäî Ïò§ÎûòÎêòÏóàÎã§",de:"Der Laden des Bruders war alt"},{ko:"Í∑∏ ÌÉùÏãúÎèÑ ÏûëÏïòÎã§",de:"Das Taxi war auch klein"},{ko:"Í∑∏ ÎÇ®ÏûêÎäî ÌñâÎ≥µÌñàÎã§",de:"Der Mann war gl√ºcklich"},{ko:"Ï†Ä Ïò§Îπ†Îäî ÏûòÏÉùÍ≤ºÎã§",de:"Jener Bruder sah gut aus"},{ko:"Ï†Ä ÏïÑÏ†ÄÏî®Îäî Îö±Îö±ÌñàÎã§",de:"Jener Mann war dick"},{ko:"Ï†Ä ÏûêÏ†ÑÍ±∞Îäî ÏúÑÌóòÌñàÎã§",de:"Jenes Fahrrad war gef√§hrlich"},{ko:"Í∑∏ ÎÇ®ÏûêÎäî ÌñâÎ≥µÌïòÍ≤†Îã§",de:"Der Mann wird gl√ºcklich sein"},{ko:"Ï†Ä ÏûêÏ†ÑÍ±∞Îäî ÏúÑÌóòÌïòÍ≤†Îã§",de:"Jenes Fahrrad wird gef√§hrlich sein"}];
    const dataL4=[{ko:"ÎÇòÎäî ÏßÄÍ∏à Í≥µÎ∂ÄÌï¥",de:"Ich lerne jetzt (informell)"},{ko:"ÏïÑÎ≤ÑÏßÄÎäî ÏßÄÍ∏à ÏûÖÏùÑ Ïó¥Ïñ¥",de:"Der Vater √∂ffnet jetzt den Mund"},{ko:"ÏπúÍµ¨Îäî 10ÏãúÏóê Îñ†ÎÇò",de:"Der Freund geht um 10 Uhr weg"},{ko:"ÏÇºÏ¥åÏùÄ Ïò§Îäò ÏòÅÏñ¥Î•º Î∞∞ÏõåÏöî",de:"Der Onkel lernt heute Englisch"},{ko:"Ïö∞Î¶¨ ÎÇ®Ìé∏ÎèÑ ÏÉùÍ∞ÅÌï©ÎãàÎã§",de:"Mein Ehemann denkt auch (formell)"},{ko:"ÌÉùÏãúÎäî Í≥µÌï≠ÏóêÎèÑ Í∞ëÎãàÎã§",de:"Das Taxi f√§hrt auch zum Flughafen"},{ko:"Ï†ÄÍ∏∞Ïóê ÏÇ¨Í≥ºÍ∞Ä ÏûàÏäµÎãàÎã§",de:"Dort gibt es einen Apfel"},{ko:"ÎÇòÎèÑ ÎπÑÎ∞ÄÏù¥ ÏûàÏäµÎãàÎã§",de:"Ich habe auch ein Geheimnis"},{ko:"ÎÇ¥ ÏûòÏÉùÍ∏¥ ÏπúÍµ¨Îäî Ïñ¥Ï†ú Ï∂§Ï∑ÑÏñ¥",de:"Mein gutaussehender Freund hat gestern getanzt"},{ko:"ÎÇ¥ Ïä¨Ìîà ÏÇ¨Í≥ºÎäî Ïñ¥Ï†ú Ïù¥ Î∞îÎÇòÎÇòÎ•º Î®πÏóàÏñ¥",de:"Mein trauriger Apfel hat gestern diese Banane gegessen"},{ko:"Í∏∞Ï∞®Îäî ÌïúÏãúÏóê Îñ†ÎÇ¨Ïñ¥",de:"Der Zug fuhr um 1 Uhr ab"},{ko:"ÎÇ¥ Ïä¨Ìîà ÏÇ¨Í≥ºÎäî Ïñ¥Ï†ú Ïù¥ Î∞îÎÇòÎÇòÎ•º Ï¢ãÏïÑÌñàÏñ¥Ïöî",de:"Mein trauriger Apfel mochte gestern diese Banane"},{ko:"Í∏∞Ï∞®Îäî ÌïúÏãúÏóê Í±∏ÏóàÏñ¥Ïöî",de:"Der Zug ist um 1 Uhr gelaufen"},{ko:"ÎÇ¥ ÏûòÏÉùÍ∏¥ ÏπúÍµ¨Îäî Ïñ¥Ï†ú ÏôîÏñ¥Ïöî",de:"Mein gutaussehender Freund ist gestern gekommen"},{ko:"Ï†ÄÎäî ÌïúÏãúÏóê Í±∏ÏóàÏäµÎãàÎã§",de:"Ich bin um 1 Uhr gelaufen"},{ko:"Ï†ú ÏûòÏÉùÍ∏¥ ÏπúÍµ¨Îäî Ïñ¥Ï†ú ÏôîÏäµÎãàÎã§",de:"Mein gutaussehender Freund ist gestern gekommen"},{ko:"Ï†ú Ïä¨Ìîà ÏÇ¨Í≥ºÎäî Ïñ¥Ï†ú Ïù¥ Î∞îÎÇòÎÇòÎ•º Ï¢ãÏïÑÌñàÏäµÎãàÎã§",de:"Mein trauriger Apfel mochte gestern diese Banane"},{ko:"ÎÇòÎäî Ï∞® ÏïàÏóêÏÑú Ïö¥ÎèôÌïòÍ≤†Ïñ¥",de:"Ich werde im Auto Sport machen"},{ko:"ÏÑ†ÏÉùÎãòÏùÄ Í∞ÄÍ≤å ÏïûÏóêÏÑú ÏòÅÌôîÎ•º Î≥¥Í≤†Ïñ¥",de:"Der Lehrer wird vor dem Laden einen Film sehen"},{ko:"ÎèôÏÉùÏùÄ ÏÉùÏÑ†ÏùÑ ÎÇ¥Ïùº ÎßåÏßÄÍ≤†Ïñ¥Ïöî",de:"Das Geschwister wird morgen den Fisch anfassen"},{ko:"ÎÇòÎäî Ïñ∏Îçï ÏòÜÏóêÏÑú ÏûêÍ≤†Ïñ¥Ïöî",de:"Ich werde neben dem H√ºgel schlafen"},{ko:"Ï†ÄÎäî Î™©ÏöîÏùºÏóê Ï≤≠ÏÜåÌïòÍ≤†ÏäµÎãàÎã§",de:"Ich werde am Donnerstag putzen"},{ko:"Ï†ÄÎäî ÏïΩÏÜçÌïòÍ≤†ÏäµÎãàÎã§",de:"Ich werde versprechen"},{ko:"Ïù¥ ÌÅ∞ ÎπÑÎ∞ÄÏùÄ ÏúÑÌóòÌñàÏñ¥Ïöî",de:"Dieses gro√üe Geheimnis war gef√§hrlich"},{ko:"Ï†Ä ÌïôÍµêÏùò ÌôîÏû•Ïã§ÏùÄ Ïã´ÏóàÏñ¥Ïöî",de:"Ich mochte die Toilette jener Schule nicht"},{ko:"Ï†Ä Ìï†Î®∏ÎãàÏùò ÏÇ¨Í≥ºÎäî ÎßõÏûàÏóàÏäµÎãàÎã§",de:"Der Apfel jener Gro√ümutter war lecker"},{ko:"Ï†Ä ÏßëÏùÄ Î©ÄÏñ¥Ïöî",de:"Jenes Haus ist weit weg"},{ko:"Ïö∞Î¶¨ ÏßëÏùÄ ÏûëÏïÑ",de:"Unser Haus ist klein"},{ko:"Ï†Ä ÎÇ®ÏûêÎäî Îπ†Î¶ÖÎãàÎã§",de:"Jener Mann ist schnell"},{ko:"Ï†Ä Ïó¨ÏûêÎäî ÌñâÎ≥µÌï©ÎãàÎã§",de:"Jene Frau ist gl√ºcklich"},{ko:"Ï†ú ÌÉùÏãúÎäî ÎπÑÏååÏñ¥Ïöî",de:"Mein Taxi war teuer"}];

    // --- 3. SPEECH API SAFETY WRAPPER ---
    let recognition = null;
    let isListening = false;
    let speechEnabled = false;

    // We wrap this in a TRY block so the game doesn't crash on iPhone/Firefox
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            speechEnabled = true;

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('mic-btn').classList.add('listening');
                document.getElementById('speech-feedback').innerText = "Listening...";
            };
            recognition.onend = function() {
                isListening = false;
                document.getElementById('mic-btn').classList.remove('listening');
            };
            recognition.onresult = function(event) {
                const spokenText = event.results[0][0].transcript;
                checkSpeech(spokenText);
            };
            recognition.onerror = function() {
                document.getElementById('speech-feedback').innerText = "Missed it. Try again.";
            };
        }
    } catch(e) {
        console.log("Speech API not available");
    }

    // --- 4. GAME ENGINE ---
    let queue = [];
    let current = null;
    let score = 0;
    let mode = 'READ';

    // Make function global so HTML buttons can find it
    window.startGame = function(level) {
        let src = [];
        if(level===1) src = dataL1; else if(level===2) src = dataL2; else if(level===3) src = dataL3; else src = dataL4;
        
        queue = JSON.parse(JSON.stringify(src));
        queue.sort(() => Math.random() - 0.5);
        score = 0;
        updateStats();
        
        // Switch Screen
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('game-screen').classList.add('active');
        
        nextCard();
    }

    function nextCard() {
        if(queue.length === 0) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('finish-screen').classList.add('active');
            return;
        }
        current = queue.shift();
        
        // Randomize Mode
        const r = Math.random();
        const badge = document.getElementById('badge-display');
        const frontTxt = document.getElementById('front-text');
        const frontSub = document.getElementById('front-sub');
        const frontAudio = document.getElementById('front-audio-btn');
        const micArea = document.getElementById('mic-area');
        const feedback = document.getElementById('speech-feedback');

        // Reset
        document.getElementById('flashcard').classList.remove('is-flipped');
        frontTxt.classList.remove('blurred', 'korean', 'german');
        micArea.style.display = 'none';
        feedback.innerText = "Tap mic & speak";
        feedback.className = "speech-feedback";
        
        if (r < 0.33) {
            // MODE: READ
            mode = 'READ';
            badge.innerText = "üìñ Read"; badge.className = "mode-badge bg-read";
            frontTxt.innerText = current.ko;
            frontTxt.classList.add('korean');
            frontSub.innerText = "";
            frontAudio.style.display = "flex";
        } else if (r < 0.66) {
            // MODE: LISTEN
            mode = 'LISTEN';
            badge.innerText = "üëÇ Listen"; badge.className = "mode-badge bg-listen";
            frontTxt.innerText = current.ko;
            frontTxt.classList.add('korean', 'blurred');
            frontSub.innerText = "(Hidden)";
            frontAudio.style.display = "flex";
            setTimeout(playAudio, 500);
        } else {
            // MODE: SPEAK
            mode = 'SPEAK';
            badge.innerText = "üó£Ô∏è Speak Korean"; badge.className = "mode-badge bg-speak";
            frontTxt.innerText = current.de;
            frontTxt.classList.add('german');
            frontSub.innerText = "(Say the Korean)";
            frontAudio.style.display = "none";
            // Only show mic if supported
            if(speechEnabled) micArea.style.display = 'flex';
        }

        document.getElementById('back-korean').innerText = current.ko;
        document.getElementById('back-german').innerText = current.de;
        updateStats();
    }

    // --- INTERACTIONS ---
    window.activateMic = function() {
        if(isListening || !recognition) return;
        recognition.start();
    }

    function checkSpeech(spoken) {
        const cleanSpoken = spoken.replace(/\s+/g, '').replace(/[.,?!]/g, '');
        const cleanTarget = current.ko.replace(/\s+/g, '').replace(/[.,?!]/g, '');
        const feedback = document.getElementById('speech-feedback');
        
        if (cleanSpoken === cleanTarget) {
            feedback.innerText = "Correct! " + spoken;
            feedback.className = "speech-feedback match-success";
            setTimeout(() => {
                document.getElementById('flashcard').classList.add('is-flipped');
                handleResult(true);
            }, 1000);
        } else {
            feedback.innerText = "Heard: " + spoken;
            feedback.className = "speech-feedback match-fail";
        }
    }

    // Flip logic (Global for HTML access)
    document.getElementById('card-scene').onclick = function() {
        const card = document.getElementById('flashcard');
        if (!card.classList.contains('is-flipped')) {
            card.classList.add('is-flipped');
            if(mode === 'SPEAK') setTimeout(playAudio, 300);
        }
    };

    function updateStats() {
        document.getElementById('score-val').innerText = score;
        document.getElementById('rem-val').innerText = queue.length + (current ? 1 : 0);
    }

    window.handleResult = function(success) {
        if(success) score += 10;
        else queue.splice(Math.min(queue.length, 3), 0, current);
        updateStats();
        document.getElementById('flashcard').classList.remove('is-flipped');
        setTimeout(nextCard, 500);
    }

    window.playAudio = function() {
        if(!current) return;
        const txt = current.ko;
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(txt)}&tl=ko&client=tw-ob`;
        new Audio(url).play().catch(e => {
            if (window.speechSynthesis) {
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'ko-KR';
                window.speechSynthesis.speak(u);
            }
        });
    }

</script>
</body>
</html>